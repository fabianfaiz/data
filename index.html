<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Deteksi Kemiringan Ruangan</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

<style>
body{
  font-family:Segoe UI,Arial,sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:24px;
  color:#2c3e50;
}
h3{margin:0}
.subtitle{color:#666;margin-bottom:20px}
.top-bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
.angle-box{
  background:#1e88e5;
  color:#fff;
  padding:12px 20px;
  border-radius:12px;
}
button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
.btn-reset{background:#e53935;color:#fff}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:16px;
}
.box{
  background:#fff;
  border-radius:14px;
  padding:12px;
  text-align:center;
}
canvas{
  width:100%!important;
  max-width:220px;
  aspect-ratio:1/1;
}
footer{
  margin-top:30px;
  text-align:center;
  font-size:12px;
  color:#888;
}
</style>
</head>

<body>

<h3>Visualisasi Kemiringan Ruangan</h3>
<div class="subtitle">ESP32 + MPU6050</div>

<div class="top-bar">
  <div class="angle-box">
    Sudut Gabungan: <b><span id="angle">-</span></b>
  </div>
  <button onclick="saveWall()">Simpan Dinding</button>
  <button onclick="saveFloor()">Simpan Lantai</button>
  <button class="btn-reset" onclick="resetAll()">Reset</button>
</div>

<div class="grid">
  <div class="box"><b>Live</b><div id="live"></div></div>
  <div class="box"><b>Dinding</b><div id="wall"></div></div>
  <div class="box"><b>Lantai</b><div id="floor"></div></div>
  <div class="box"><b>Gabungan</b><div id="combine"></div></div>
</div>

<footer>Monitoring Kemiringan Ruangan</footer>

<script>
/* ===== CONFIG ===== */
const ESP32 = "http://192.168.1.16";
const FETCH_DELAY = 200; // ms

let savedWall = null;
let savedFloor = null;
let lastFetch = 0;

/* ===== THREE SETUP ===== */
function createView(id){
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(70,1,0.1,100);
  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(220,220);
  document.getElementById(id).appendChild(renderer.domElement);
  camera.position.set(3,3,5);
  camera.lookAt(0,0,0);
  return {scene,camera,renderer};
}

const liveView  = createView("live");
const wallView  = createView("wall");
const floorView = createView("floor");
const combView  = createView("combine");

function plane(w,h){
  return new THREE.Mesh(
    new THREE.BoxGeometry(w,h,0.1),
    new THREE.MeshNormalMaterial()
  );
}

const livePlane = plane(2,0.3);
liveView.scene.add(livePlane);

/* ===== ROTATION ===== */
function applyRotation(obj,d){
  obj.rotation.x = Math.atan2(d.ax, Math.sqrt(d.ay*d.ay+d.az*d.az));
  obj.rotation.z = Math.atan2(d.ay, Math.sqrt(d.ax*d.ax+d.az*d.az));
}

function getAngles(d){
  return {
    pitch: Math.atan2(d.ax, Math.sqrt(d.ay*d.ay+d.az*d.az)),
    roll : Math.atan2(d.ay, Math.sqrt(d.ax*d.ax+d.az*d.az))
  };
}

function normalWall(a){
  return {x:Math.sin(a.roll), y:0, z:Math.cos(a.roll)};
}
function normalFloor(a){
  return {x:0, y:Math.sin(a.pitch), z:Math.cos(a.pitch)};
}

function angleBetween(n1,n2){
  const dot=n1.x*n2.x+n1.y*n2.y+n1.z*n2.z;
  const m1=Math.hypot(n1.x,n1.y,n1.z);
  const m2=Math.hypot(n2.x,n2.y,n2.z);
  return Math.acos(dot/(m1*m2))*180/Math.PI;
}

/* ===== SAVE ===== */
function saveWall(){
  fetch(`${ESP32}/data`).then(r=>r.json()).then(d=>{
    savedWall=d;
    wallView.scene.clear();
    const w=plane(2,2);
    applyRotation(w,d);
    wallView.scene.add(w);
    updateCombine();
  });
}

function saveFloor(){
  fetch(`${ESP32}/data`).then(r=>r.json()).then(d=>{
    savedFloor=d;
    floorView.scene.clear();
    const f=plane(2,2);
    applyRotation(f,d);
    f.rotation.x+=Math.PI/2;
    floorView.scene.add(f);
    updateCombine();
  });
}

/* ===== COMBINE ===== */
function updateCombine(){
  if(!savedWall||!savedFloor)return;
  combView.scene.clear();

  const aw=getAngles(savedWall);
  const af=getAngles(savedFloor);

  const angle=angleBetween(
    normalWall(aw),
    normalFloor(af)
  );

  document.getElementById("angle").innerText=angle.toFixed(2)+"Â°";
}

/* ===== RESET ===== */
function resetAll(){
  savedWall=savedFloor=null;
  wallView.scene.clear();
  floorView.scene.clear();
  combView.scene.clear();
  document.getElementById("angle").innerText="-";
}

/* ===== LOOP WITH DELAY ===== */
function animate(time){
  if(time-lastFetch>FETCH_DELAY){
    lastFetch=time;
    fetch(`${ESP32}/data`)
      .then(r=>r.json())
      .then(d=>applyRotation(livePlane,d))
      .catch(()=>{});
  }

  [liveView,wallView,floorView,combView].forEach(v=>{
    v.renderer.render(v.scene,v.camera);
  });

  requestAnimationFrame(animate);
}
animate(0);
</script>

</body>
</html>
